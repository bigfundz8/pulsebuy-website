"use strict";(()=>{var e={};e.id=4105,e.ids=[4105],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5184:e=>{e.exports=require("nodemailer")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9616:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>l,routeModule:()=>c});var a=r(1802),o=r(7153),i=r(6249),s=r(9004),d=e([s]);s=(d.then?(await d)():d)[0];let l=(0,i.l)(s,"default"),u=(0,i.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/webhooks/stripe",pathname:"/api/webhooks/stripe",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},5130:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(1185),a=r.n(n);let o="mongodb://localhost:27017/dropshipmotion";if(!o)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let i=global.mongoose;async function s(){if(i.conn)return i.conn;i.promise||(i.promise=a().connect(o,{bufferCommands:!1,retryWrites:!0}).then(e=>(console.log("Connected to MongoDB"),e)));try{i.conn=await i.promise}catch(e){throw i.promise=null,e}return i.conn}i||(i=global.mongoose={conn:null,promise:null});let d=s},7264:(e,t,r)=>{r.d(t,{Z:()=>i});var n=r(1185),a=r.n(n);let o=new(a()).Schema({orderNumber:{type:String,required:!0,unique:!0},user:{type:a().Schema.Types.ObjectId,ref:"User",required:!1},items:[{product:{type:a().Schema.Types.ObjectId,ref:"Product",required:!0},quantity:{type:Number,required:!0,min:1},price:{type:Number,required:!0},total:{type:Number,required:!0}}],shippingAddress:{firstName:{type:String,required:!0},lastName:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},postalCode:{type:String,required:!0},country:{type:String,required:!0},phone:String},billingAddress:{firstName:{type:String,required:!0},lastName:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},postalCode:{type:String,required:!0},country:{type:String,required:!0}},payment:{method:{type:String,enum:["stripe","ideal","paypal","card"],required:!0},status:{type:String,enum:["pending","paid","failed","refunded"],default:"pending"},transactionId:String,amount:{type:Number,required:!0}},status:{type:String,enum:["pending","paid","confirmed","processing","shipped","delivered","cancelled"],default:"pending"},shipping:{method:{type:String,required:!0},cost:{type:Number,required:!0},trackingNumber:String,estimatedDelivery:Date,actualDelivery:Date},totals:{subtotal:{type:Number,required:!0},shipping:{type:Number,required:!0},tax:{type:Number,required:!0},total:{type:Number,required:!0}},notes:String,dropshipStatus:{type:String,enum:["pending","forwarded","shipped","completed","failed"],default:"pending"},dropshipInstructions:String,dropshipCost:Number,profit:Number,profitMargin:Number,trackingEvents:[{status:String,message:String,timestamp:{type:Date,default:Date.now}}]},{timestamps:!0});o.pre("save",async function(e){if(!this.orderNumber){let e=await a().model("Order").countDocuments();this.orderNumber=`ORD-${Date.now()}-${String(e+1).padStart(4,"0")}`}e()}),o.methods.updateStatus=function(e,t){return this.status=e,this.trackingEvents.push({status:e,message:t||`Status gewijzigd naar ${e}`,timestamp:new Date}),this.save()},o.virtual("totalItems").get(function(){return this.items.reduce((e,t)=>e+t.quantity,0)});let i=a().models.Order||a().model("Order",o)},9004:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>d});var a=r(6090),o=r(5130),i=r(7264),s=e([a]);let b=new(a=(s.then?(await s)():s)[0]).default("sk_test_your_stripe_secret_key_here",{apiVersion:"2023-10-16"});async function d(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});await (0,o.Z)();try{let r;let n=e.headers["stripe-signature"],a=process.env.STRIPE_WEBHOOK_SECRET;try{r=b.webhooks.constructEvent(e.body,n,a)}catch(e){return console.error("❌ Webhook signature verificatie gefaald:",e.message),t.status(400).json({message:"Webhook signature verificatie gefaald"})}switch(console.log("\uD83D\uDD14 Stripe webhook ontvangen:",r.type),r.type){case"payment_intent.succeeded":await l(r.data.object);break;case"payment_intent.payment_failed":await u(r.data.object);break;case"payment_intent.canceled":await c(r.data.object);break;case"payment_intent.requires_action":await p(r.data.object);break;default:console.log(`⚠️ Onbekend event type: ${r.type}`)}t.status(200).json({received:!0})}catch(e){console.error("❌ Webhook verwerking fout:",e),t.status(500).json({message:"Webhook verwerking gefaald"})}}async function l(e){console.log("✅ Betaling succesvol:",e.id);try{let t=await i.Z.findOne({paymentIntentId:e.id});t?(await i.Z.findByIdAndUpdate(t._id,{status:"confirmed",paymentStatus:"succeeded",paidAt:new Date,lastUpdated:new Date}),console.log("✅ Order bevestigd:",t.orderNumber),await g(t),await m(t)):console.error("❌ Order niet gevonden voor Payment Intent:",e.id)}catch(e){console.error("❌ Fout bij verwerken succesvolle betaling:",e.message)}}async function u(e){console.log("❌ Betaling gefaald:",e.id);try{let t=await i.Z.findOne({paymentIntentId:e.id});t?(await i.Z.findByIdAndUpdate(t._id,{status:"payment_failed",paymentStatus:"failed",paymentFailureReason:e.last_payment_error?.message,lastUpdated:new Date}),console.log("❌ Order gemarkeerd als gefaald:",t.orderNumber),await y(t)):console.error("❌ Order niet gevonden voor gefaalde Payment Intent:",e.id)}catch(e){console.error("❌ Fout bij verwerken gefaalde betaling:",e.message)}}async function c(e){console.log("\uD83D\uDEAB Betaling geannuleerd:",e.id);try{let t=await i.Z.findOne({paymentIntentId:e.id});t?(await i.Z.findByIdAndUpdate(t._id,{status:"cancelled",paymentStatus:"canceled",cancelledAt:new Date,lastUpdated:new Date}),console.log("\uD83D\uDEAB Order geannuleerd:",t.orderNumber)):console.error("❌ Order niet gevonden voor geannuleerde Payment Intent:",e.id)}catch(e){console.error("❌ Fout bij verwerken geannuleerde betaling:",e.message)}}async function p(e){console.log("⚠️ Betaling vereist actie:",e.id);try{let t=await i.Z.findOne({paymentIntentId:e.id});t?(await i.Z.findByIdAndUpdate(t._id,{status:"requires_action",paymentStatus:"requires_action",lastUpdated:new Date}),console.log("⚠️ Order vereist actie:",t.orderNumber)):console.error("❌ Order niet gevonden voor Payment Intent die actie vereist:",e.id)}catch(e){console.error("❌ Fout bij verwerken Payment Intent die actie vereist:",e.message)}}async function g(e){console.log("\uD83D\uDCE7 Order bevestigingsemail verzenden voor:",e.orderNumber);try{let{sendOrderConfirmationEmail:t}=await r.e(2206).then(r.bind(r,2206));await t(e),console.log("✅ Order bevestigingsemail verzonden")}catch(e){console.error("❌ Fout bij verzenden order bevestigingsemail:",e.message)}}async function m(e){console.log("\uD83D\uDCE6 Order doorsturen naar leveranciers voor:",e.orderNumber);try{(await fetch("http://localhost:3000/api/automation/auto-order-forwarding",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.CRON_API_KEY},body:JSON.stringify({orderId:e._id})})).ok?console.log("✅ Order doorgestuurd naar leveranciers"):console.error("❌ Fout bij doorsturen order naar leveranciers")}catch(e){console.error("❌ Fout bij order forwarding:",e.message)}}async function y(e){console.log("\uD83D\uDCE7 Gefaalde betaling email verzenden voor:",e.orderNumber);try{let t=(await Promise.resolve().then(r.t.bind(r,5184,23))).createTransporter({host:process.env.SMTP_HOST||"smtp.gmail.com",port:parseInt(process.env.SMTP_PORT)||587,secure:!1,auth:{user:process.env.SMTP_USER||"your-email@gmail.com",pass:process.env.SMTP_PASS||"your-app-password"}}),n={from:process.env.SMTP_USER||"your-email@gmail.com",to:e.shippingAddress.email,subject:`⚠️ Betaling gefaald - Order #${e.orderNumber}`,html:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #dc2626;">⚠️ Betaling Gefaald</h1>
          <p>Hallo ${e.shippingAddress.firstName},</p>
          <p>Helaas is de betaling voor je bestelling #${e.orderNumber} gefaald.</p>
          <p><strong>Reden:</strong> ${e.paymentFailureReason||"Onbekend"}</p>
          <p>Je kunt je bestelling opnieuw proberen te betalen via de volgende link:</p>
          <a href="http://localhost:3000/checkout?retry=${e.orderNumber}" 
             style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block;">
            Opnieuw Betalen
          </a>
          <p>Als je vragen hebt, neem dan contact met ons op.</p>
          <p>Met vriendelijke groet,<br>Het PulseBuy Team</p>
        </div>
      `};await t.sendMail(n),console.log("✅ Gefaalde betaling email verzonden")}catch(e){console.error("❌ Fout bij verzenden gefaalde betaling email:",e.message)}}n()}catch(e){n(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9616);module.exports=r})();